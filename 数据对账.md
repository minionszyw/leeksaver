# LeekSaver 全量数据对账与穿透式审计手册 (V2.0)

本手册基于 LeekSaver 数据库 22 个核心数据表，定义了覆盖全业务领域的“穿透式审计”规则。

---

## 一、 审计维度定义 (CIA 架构)
1. **Completeness (完整性)**：应有的数据是否缺失？（基于交易日历穿透）
2. **Integrity (一致性)**：关联表之间是否匹配？（如行情与技术指标的数量对应）
3. **Accuracy (逻辑准确性)**：数据是否符合业务常理？（如财务报表平衡、K线勾稽）

---

## 二、 穿透审计规则表 (按业务域)

### 1. 基础元数据域 (`stocks`, `trading_calendar`, `sectors`, `watchlist`)
- **审计规则**：
    - **退市监测**：检查 `is_active=True` 的股票是否在最新抓取清单中。
    - **日历闭环**：验证 `trading_calendar` 中过去 2 年的 `is_open` 状态与 `daily_quotes` 的实际交易分布是否吻合。
    - **关联性**：验证 `stocks` 表中的行业分类是否与 `sectors` 表完全对齐。

### 2. 行情数据域 (`daily_quotes`, `minute_quotes`)
- **审计规则**：
    - **K线勾稽**：`high >= low`, `high >= open`, `high >= close`, `low <= open`, `low <= close`。
    - **量纲校准**：`amount / volume` (均价) 必须位于 `[low * 0.8, high * 1.2]` 区间，识别 100 倍误差。
    - **空洞扫描**：对活跃标的，扫描其历史序列是否存在中间断档（除停牌外）。

### 3. 财务与经营域 (`financial_statements`, `operation_data`)
- **审计规则**：
    - **周期性校验**：每只股票每季度必须有一条 `financial_statements` 记录。
    - **主营平衡**：`operation_data` 中的各项构成占比总和应接近 100%。
    - **逻辑勾稽**：验证营收、利润等关键指标在不同表之间的一致性。

### 4. 资金流向域 (`northbound_flows`, `stock_fund_flows`, `margin_trades`, `dragon_tiger`)
- **审计规则**：
    - **时效性校验**：北向资金与融资融券 (`margin_trades`) 应保持 T+1 的更新节奏。
    - **个股 vs 市场**：`stock_fund_flows` 的总额应能逻辑上支持对应日期的 `daily_quotes` 成交额。
    - **龙虎榜**：`dragon_tiger` 中的代码必须存在于 `stocks` 表。

### 5. 情绪与指标域 (`market_sentiments`, `limit_up_stocks`, `tech_indicators`, `daily_valuations`)
- **审计规则**：
    - **指标覆盖**：对于有 `daily_quotes` 的每一条记录，必须对应生成 `tech_indicators` 和 `daily_valuations`。
    - **涨停一致性**：`limit_up_stocks` 表中的标的，其当日 `daily_quotes.change_pct` 必须接近涨停阈值。
    - **极值校验**：`PE/PB` 出现负值或超过 10000 的记录需标记审计。

### 6. 新闻与文本域 (`news_articles`, `stock_news_articles`)
- **审计规则**：
    - **关联性**：所有 `stock_news_articles` 的关联 ID 必须在 `news_articles` 中存在。
    - **新鲜度**：每日 0 点检查过去 24 小时是否有新快讯入库。

### 7. 系统与错误域 (`sync_errors`, `alembic_version`)
- **审计规则**：
    - **顽疾监测**：单标的 24 小时内失败频率触发阈值（3次）即上报。
    - **版本检查**：确保迁移版本与当前后端代码库一致。

---

## 三、 审计执行流程 (Data Doctor Ultra)

1. **第一阶段：每日 00:00 - SQL 全量审计**
   系统下推全量 SQL 任务，遍历以上 22 个表的 CIA 规则。
2. **第二阶段：自动分诊**
   - **自愈型**：行情缺失、指标未计算。 -> 自动下发 `Celery` 补录。
   - **风险型**：大规模数据塌陷、系统新鲜度断裂。 -> **立即邮件报警**。
   - **业务型**：财务数据不平衡、标的异常退市。 -> **熔断并邮件报警**。
3. **第三阶段：30分钟 T+1 复查**
   针对自愈型问题执行复诊，若复诊失败，自动转为“风险型”发送邮件。

---
**核审员**：Gemini Engineer
**版本**：V2.0 Fully-Audit