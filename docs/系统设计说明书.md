# LeekSaver 智能投研 Agent 系统设计说明书 (v1.5)

---

## 1. 项目目标与定位

LeekSaver 是一个**本地化部署**的智能投研 Agent 系统，面向个人投资者，提供对中国 A 股市场（股票、ETF）的**查询、分析与辅助决策能力**。

系统核心目标是：
在 **有限计算资源 + 免费数据源** 的现实约束下，提供**可靠、可解释、可交互**的投研能力，对标同花顺「问财」的**核心查询与解释能力**，但不追求其商业级实时性与覆盖广度。

系统**不直接给出投资建议或买卖指令**，只提供基于数据的分析与解释。

---

## 2. 核心设计原则

### 2.1 职责与计算边界

* **职责隔离原则**
  * LLM 仅承担：
    * 用户意图识别
    * 查询与分析任务编排
    * 结果总结与自然语言解释
  * LLM **不参与任何数值计算、指标推导或统计处理**。

* **计算下沉原则**
  * 所有计算任务必须由：
    * 数据库（SQL / TimescaleDB）
    * 或本地数据处理引擎（Polars）
    * 完成后再返回结构化结果供 LLM 解释。

---

### 2.2 契约优先与系统自愈

* **Contract First**
  * LLM 与系统工具之间的交互必须遵循显式 JSON Schema。
  * 所有工具输入与输出均可被自动校验。

* **自愈机制**
  * 当 LLM 输出未通过 Schema 校验时：
    1. 系统将错误信息反馈给 LLM
    2. 触发一次反思修正重试
    3. 若仍失败，则执行降级或向用户报告失败
  * 不进行无限重试，不掩盖错误。

---

### 2.3 数据真实性与透明性

* 系统不得编造或猜测数据。
* 无法获取或数据过期时，必须明确告知用户：
  * 数据缺失原因
  * 数据时间戳
  * 是否正在尝试更新

---

## 3. 功能范围与能力边界

### 3.1 支持的资产范围

* 中国 A 股市场：
  * 上市公司股票
  * 场内 ETF

---

### 3.2 核心功能类型

系统聚焦于**查询与分析能力**，不承担账户或资产管理类操作。

1. **数据速查（Fact Query）**
   * 示例：最新价、市值、PE、历史涨跌幅
   * 特点：
     * 直接查询结构化数据
     * 不触发复杂分析链

2. **深度分析（Deep Analysis）**
   * 包含：
     * 技术趋势分析（以日线为主）
     * 基本面摘要（关键财务指标、同比变化）
     * 结合新闻与公告的背景解释
   * 允许调用数据计算与语义检索能力

---

### 3.3 非 Agent 能力范围（明确边界）

* 以下功能**不由 Agent 通过自然语言指令完成**：
  * 自选股的新增、移除、排序
  * 监控规则的开关与配置
* 上述能力由**传统 Web UI** 提供（如点击星标进行收藏），Agent 仅感知最终状态结果。
---

## 4. Agent 架构与交互流程

### 4.1 意图路由与任务编排

* 系统采用**显式意图路由机制**：
  * 将用户输入解析为查询或分析任务
  * 不解析、不执行具有副作用的操作型指令
* Agent 按明确任务类型执行，不进行隐式推断或越权操作。

---

### 4.2 诊断式分析流程

当分析请求依赖的数据不可用或已过期时，系统采用**诊断式分析流程**：

1. **数据就绪检查**
   * 判断所需数据是否存在或已过期

2. **即时反馈**
   * 若需同步数据，系统立即向用户反馈当前状态

3. **后台处理**
   * 后台完成数据获取、入库与计算

4. **结果返回**
   * 数据准备完成后，返回最终分析结论

系统需避免用户在分析过程中出现长时间无反馈的“假死”体验。

---

## 5. 多轮对话与上下文管理

### 5.1 会话管理

* 系统支持多轮自然语言对话。
* 不同会话（Session）之间上下文完全隔离。

---

### 5.2 上下文与大数据文件化策略

* 系统保留最近 N 轮对话的**原始文本**，用于意图理解与指代消解。
* 对于以下内容：
  * 大规模表格数据
  * 长时间序列计算结果
  * 成段的中间分析数据
    系统**不直接注入 LLM 上下文**。

* **大数据文件化原则**
  * 大体量数据以文件或结构化存储形式持久化
  * LLM 仅接收：
    * 数据引用标识
    * 统计摘要
    * 必要的关键结论
  * 防止 Token 消耗失控与上下文污染

---

## 6. 数据架构与治理

### 6.1 数据源与适配

* 使用免费数据源（如 AkShare）作为主要数据来源。
* 数据访问通过统一接口层进行隔离。
* 系统需具备基础限频与随机抖动机制，避免触发数据源风控。

---

### 6.2 数据类型与生命周期

#### 行情数据

* **日线数据**
  * 作为主要历史分析数据
  * 存储最近 2 年

* **分钟级数据**
  * 用于短期状态判断与监控
  * 仅保留短期数据

#### 基本面与新闻
* 财务数据以结构化摘要形式存储
* 新闻与公告以文本 + 向量形式存储
* 定期清理过期内容

---

### 6.3 分级同步策略

* **L1：定期同步**
  * 收盘后更新全市场日线数据

* **L2：重点对象同步**
  * 针对用户自选资产进行定时更新

* **L3：按需同步**
  * 当用户请求分析且数据过期时触发
  * 同步过程需配合用户可见反馈

---

## 7. 存储与基础设施

* **PostgreSQL**：业务数据、元数据、自选状态
* **TimescaleDB**：时间序列行情数据
* **pgvector**：新闻与公告向量检索
* **Redis**：
  * 缓存热点行情数据
  * 存储系统运行状态与计数信息
* **异步任务系统**：用于数据同步与计算任务

---

## 8. 系统稳定性与可观测性

### 8.1 稳定性原则

* 在数据不足、计算失败或外部依赖异常时：
  * 系统优先返回明确失败说明
  * 不返回不完整或推测性结论

---

### 8.2 可观测性要求

系统需记录以下信息用于调试与持续改进：

* 用户输入与意图解析结果
* 查询 / 分析任务执行路径
* Schema 校验失败与重试情况
* 数据同步与计算耗时

---

## 9. 迭代与扩展原则

* 初期定位为单用户、单机系统。
* 所有关键状态必须可持久化，避免依赖进程内内存。
* 架构需允许未来扩展：
  * 更多分析类型
  * 更复杂的监控逻辑
  * 多用户与多会话支持

---

## 10. 技术选型约束（参考实现）

* 后端服务：FastAPI
* Agent 框架：LangGraph + DeepSeek API
* 数据处理：Polars
* 数据库：PostgreSQL / TimescaleDB / pgvector
* 异步任务：Celery + Redis
* 前端：React + TypeScript

